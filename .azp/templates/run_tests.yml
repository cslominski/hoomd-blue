steps:
- script: PATH=/usr/lib/llvm-$(llvm_version)/bin:$PATH ctest -I $(ctest_start),,$(ctest_stride) --no-compress-output -T test --output-on-failure --test-output-size-failed 1048576 --test-output-size-passed 1048576
  displayName: Run tests
  workingDirectory: $(Build.BinariesDirectory)
  env:
    # allow openmpi to oversubscribe cores
    OMPI_MCA_rmaps_base_oversubscribe: 1
    # prevent errors from mis-configured openib systems
    OMPI_MCA_btl: "vader,self"
    # prevent deadlocked MPI tests from causing the job to cancel
    MPIEXEC_TIMEOUT: $(mpiexec_timeout)
    # workaround issues on Mac
    TMPDIR: /tmp

- task: PublishTestResults@2
  condition: or(succeeded(), failed())
  inputs:
    testResultsFormat: 'cTest'
    testResultsFiles: '$(Build.BinariesDirectory)/Testing/**/Test.xml'
    testRunTitle: $(suite_name)
